<!DOCTYPE html>
<meta charset="utf-8"/>
<title>Shine Test</title>
<script src="libshine.js"></script>
<script language="javascript" type="text/javascript">
  var audioContext;
  if (typeof webkitAudioContext !== "undefined") {
    audioContext = new webkitAudioContext(); 
  } else {
    audioContext = new AudioContext();
  }

  var mount = "/mount";
  var bitrate = 64;
  var channels = 1;
  var samplerate = audioContext.sampleRate;

  var wsUri = "ws://localhost:8080/";
  var websocket = new WebSocket(wsUri, "webcast");
  websocket.onopen = function(evt) {
    console.log("Websocket connected.");
    websocket.send(JSON.stringify({
      type: "hello",
      data: {
        mime:  "audio/mpeg",
        mount: "/mount",
        audio: {
          channels: channels,
          samplerate: samplerate,
          bitrate: bitrate,
          encoder: "libshine"
        }
      }
    }));
  };
  websocket.onclose = function(evt) { console.log("Websocket disconnected."); };
  websocket.onmessage = function(evt) { console.log("Websocket message: " + evt.data); };
  websocket.onerror = function(evt) { console.log("Websocket error: " + evt.data) };

  var shine = new Shine({
    bitrate: bitrate,
    samplerate: samplerate,
    channels: channels,
    mode: channels == 1 ? Shine.MONO : Shine.STEREO
  });

  function processBuffer(buf) {
    console.log("Got buffer.");
    var encoded = shine.encode([buf.getChannelData(0)]);
    if (encoded.length > 0) {
      console.log("Sending " + encoded.length + " bytes of compressed data");
      websocket.send(encoded.buffer.slice(encoded.byteOffset, encoded.length));
    }
  }

  function onAudioProcess(e) {
    processBuffer(e.inputBuffer);
  }

  var buflen = 4096;

  function connectStream(source) {
    console.log("Connect stream.")
    var node = audioContext.createJavaScriptNode(buflen, 2, 2);
    console.log("Created node.");

    source.connect(node);
    node.onaudioprocess = onAudioProcess;
    node.connect(audioContext.destination);
    console.log("Connected.");
  }

  function onStream(stream) {
    console.log("Got stream.");
    var mediaStreamSource = audioContext.createMediaStreamSource(stream);
    console.log("Created source.");
    connectStream(mediaStreamSource);
  }

  function init() {
    console.log("Initializing.");
    var recordAudio = document.getElementById('record-audio');

    recordAudio.onclick = function () {
      console.log("Clicked record.");
      navigator.webkitGetUserMedia({audio:true, video:false}, onStream, function(e) { console.log("getUserMedia error: "+e.name+" "+e.message); });
    };

    var audioUrl = "http://upload.wikimedia.org/wikipedia/en/4/45/ACDC_-_Back_In_Black-sample.ogg";
    var playAudio = document.getElementById('play-audio');

    // Webkit implementation. Should be firefox' once
    // they finish implementing the API
    if (typeof webkitAudioContext !== "undefined") {
      var audio = new Audio();
      audio.src = audioUrl;
      audio.controls = true;
      audio.autoplay = false;
      audio.loop = true;
      document.body.appendChild(audio);
      playAudio.onclick = function() {
        console.log("Clicked play.");
        audio.play();
        connectStream(audioContext.createMediaElementSource(audio));
      };
    } else {
      playAudio.onclick = function() {
        console.log("Clicked play.");
        var xhr = new XMLHttpRequest();
        xhr.open("GET", audioUrl, true);
        xhr.responseType = "arraybuffer";
        xhr.onload = function() {
          audioContext.decodeAudioData(xhr.response, processBuffer, function () {});
        };
        xhr.send();
      }
    }

    document.getElementById('send-metadata').onclick = function () {
      console.log("Send metadata.");
      websocket.send(JSON.stringify({"type": "metadata", "data": {"title":"title test", "artist": "artistic test"}}));
    }
  }

  window.addEventListener("load", init, false);
</script>

<h2>Shine Test</h2>
<button id="record-audio">Record</button>
<button id="play-audio">Play</button>
<button id="send-metadata">Send metadata</button>
<div id="output"></div>
</html>
