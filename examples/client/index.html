<!DOCTYPE html>
<meta charset="utf-8"/>
<title>Webcase client Test</title>
<script src="libshine.js"></script>
<script src="libmp3lame.js"></script>
<script src="webcast.js"></script>
<script language="javascript" type="text/javascript">
  navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

  // Configuration
  var wsUri = "ws://localhost:8080/mount";
  var fileUrl;
  var bitrate = 64;
  var channels = 1;
  var samplerate;
  var encoder = Webcast.Encoder.Lame;
  var audioContext;
  var webcastNode;
  var passThrough = false;
  var useWorker = false;
  var audioSource;

  function createAudioContext() {
    if (typeof webkitAudioContext !== "undefined") {
      audioContext = new webkitAudioContext();
    } else {
      audioContext = new AudioContext();
    }
    samplerate = audioContext.sampleRate;
  }

  function killWebcast() {
    if (audioSource) {
      audioSource.remove();
      audioSource = null;
    }
    if (webcastNode) {
      webcastNode.close();
      webcastNode = null;
    }
    if (audioContext) {
      audioContext = null;
    }
  }

  function createWebcastNode(source) {
    var enc = new encoder({
      channels: channels,
      samplerate: samplerate,
      bitrate: bitrate
    });

    if (useWorker) {
      enc = new Webcast.Encoder.Worker({
        scripts: ["http://localhost:8000/libmp3lame.js", "http://localhost:8000/libshine.js", "http://localhost:8000/webcast.js"],
        encoder: enc
      });
    }

    webcastNode = new Webcast.Node({
      uri: wsUri,
      encoder: enc,
      context: audioContext,
      options: {passThrough: passThrough}
    });
    
    source.connect(webcastNode);
    webcastNode.connect(audioContext.destination);
  }

  function createAudioSource(url) {
    killWebcast();

    audioSource = new Audio();

    audioSource.src = url;
    audioSource.controls = true;
    audioSource.autoplay = false;
    audioSource.loop = true;

    audioSource.addEventListener("canplay", function () {
      createAudioContext();
      var source = audioContext.createMediaElementSource(audioSource);
      createWebcastNode(source);
      audioSource.play();
    }, false);

    document.getElementById("player").appendChild(audioSource);
  }

  function init() {
    console.log("Initializing.");

    document.getElementById('play-audio').onclick = function() {
      createAudioSource(fileUrl);
    };

    document.getElementById('record-audio').onclick = function () {
      console.log("Clicked record.");
      navigator.getUserMedia({audio:true, video:false}, function (stream) {
        killWebcast();

        createAudioContext();
        var source = audioContext.createMediaStreamSource(stream);

        createWebcastNode(source);
      }, function(e) {
        console.log("getUserMedia error: "+e.name+" "+e.message);
      });
    };

    document.getElementById('send-metadata').onclick = function () {
      if (webcastNode) {
        console.log("Send metadata.");
        webcastNode.sendMetadata({
          title:  document.getElementById("title").value,
          artist: document.getElementById("artist").value
        });
      }
    };

    document.getElementById("lame").onchange = function () {
      if (this.checked)
        encoder = Webcast.Encoder.Lame;
    };
    document.getElementById("shine").onchange = function () {
      if (this.checked)
        encoder = Webcast.Encoder.Shine;
    };
    document.getElementById("raw").onchange = function () {
      if (this.checked)
        encoder = Webcast.Encoder.Raw;
    };

    document.getElementById("stop").onclick = function () {
      killWebcast();
    };

    document.getElementById("file").onchange = function () {
      fileUrl = URL.createObjectURL(document.getElementById("file").files[0]);
    };

    document.getElementById("asynchronous").onchange = function () {
      useWorker = this.checked;
    };

    document.getElementById("passThrough").onchange = function () {
      passThrough = this.checked; 
    };
  }

  window.addEventListener("load", init, false);
</script>

<h2>Webcast Client Test</h2>
Encoder:
<input type="radio" name="encoder" value="lame" id="lame" checked>Lame
<input type="radio" name="encoder" value="shine" id="shine">Shine
<input type="radio" name="encoder" value="raw" id="raw">Raw<br>
<br>
Play stream locally: <input type="checkbox" id="passThrough"></input><br>
Use asynchronous worker: <input type="checkbox" id="asynchronous"></input><br>
<br>
Stream from the microphone:<br>
<button id="record-audio">Record</button><br>
<br>
Choose a file to play:<br>
<div id="player">
  <input type="file" id="file" accept="audio/*"></input><br>
  <button id="play-audio">Play</button><br>
</div>
<br>
Stop Streaming:<br>
<button id="stop">Stop</button><br>
<br>
Send test metadata:<br>
Artist:
<input id="artist" type="text"></input><br>
Title:
<input id="title" type="text"></input><br>
<button id="send-metadata">Send</button><br>
<div id="output"></div>
</html>
